// ==UserScript==
// @name         2nd STREET Auto Buyer
// @namespace    https://yama773.github.io/2nd-auto-buy/
// @version      1.2
// @description  カートイン → カートページ → レジに進む まで自動化
// @match        https://www.2ndstreet.jp/*
// @grant        none
// ==/UserScript==

(function() {
  'use strict';

  const log = (...args) => console.log('[2ND AUTO]', ...args);

  const waitFor = (selector, timeout = 5000) => {
    return new Promise((resolve, reject) => {
      const interval = 100;
      let elapsed = 0;
      const timer = setInterval(() => {
        const el = document.querySelector(selector);
        if (el) {
          clearInterval(timer);
          resolve(el);
        } else if (elapsed > timeout) {
          clearInterval(timer);
          reject(`Timeout: ${selector}`);
        }
        elapsed += interval;
      }, interval);
    });
  };

  const clickIfExists = (selector) => {
    const el = document.querySelector(selector);
    if (el) {
      el.click();
      return true;
    }
    return false;
  };

  const run = async () => {
    log('Started');
    const path = location.pathname;

    if (path.startsWith('/goods/detail')) {
      // 商品ページ：カートイン
      log('商品ページ - カートイン');
      const cartBtn = await waitFor('#addCartBtn').catch(log);
      if (cartBtn) {
        cartBtn.click();
        log('カートに追加クリック');
        await new Promise(r => setTimeout(r, 2000));
        location.href = '/cart';
      }
    } else if (path === '/cart') {
      // カートページ：レジに進む
      log('カートページ - レジに進む');
      const proceedBtn = await waitFor('button[form="cart_information_detail"]').catch(log);
      if (proceedBtn) {
        proceedBtn.click();
        log('レジに進むクリック');
      }
    }
  };

  run();
})();
