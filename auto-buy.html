<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <title>2nd STREET Auto Buyer</title>
</head>
<body>
  <h3>2nd STREET 自動購入ツール</h3>
  <p>処理中です。手動でreCAPTCHAを突破する場面があれば対応してください。</p>

  <script>
    (async function(){
      const delay = ms => new Promise(res => setTimeout(res, ms));
      const params = new URLSearchParams(location.search);
      const target = params.get("target");

      if (!target) {
        document.body.innerHTML += '<p style="color:red">エラー：targetパラメータがありません。</p>';
        return;
      }

      // ステップ1：商品ページに遷移
      location.href = target;
      await delay(3000);

      // ステップ2：カートに追加（以前動作したバージョン）
      let btn;
      for (let i = 0; i < 20; i++) {
        btn = document.querySelector("#addCartBtn");
        if (btn) break;
        await delay(500);
      }
      if (btn) btn.click();
      else return alert("❌ カートボタンが見つかりません");

      await delay(2000);
      location.href = "/cart";
      await delay(2000);

      // ステップ3：レジに進む
      for (let i = 0; i < 10; i++) {
        const regibtn = document.querySelector("button.cartBtn");
        if (regibtn) {
          regibtn.click();
          break;
        }
        await delay(500);
      }

      await delay(2000);

      // ステップ4：ログイン画面だったら自動入力
      const loginId = document.querySelector("#authId");
      const password = document.querySelector('input[name="password"]');
      const loginBtn = document.querySelector("#js-submit_btn");

      if (loginId && password && loginBtn) {
        loginId.value = "09089145579";
        password.value = "s2518190";
        await delay(500);
        loginBtn.click(); // reCAPTCHA表示時はここで手動対応が必要
        return;
      }

      await delay(3000);

      // ステップ5：生年月日と職業入力
      const setVal = (sel, val) => {
        const el = document.querySelector(sel);
        if (el) el.value = val;
      };
      setVal('select[name="birthdayYear"]', "1990");
      setVal('select[name="birthdayMonth"]', "01");
      setVal('select[name="birthdayDay"]', "01");
      setVal('select[name="jobCode"]', "1");

      await delay(500);

      // ステップ6：最終確認へ
      const confirmBtn = document.querySelector("#submit-btn");
      if (confirmBtn) confirmBtn.click();

      await delay(1500);

      // ステップ7：ご注文を確定する
      const finalBtn = document.querySelector("#order_submit");
      if (finalBtn) finalBtn.click();

      alert("✅ 自動購入完了（または最終ボタンを実行）しました。");
    })();
  </script>
</body>
</html>
