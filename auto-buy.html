<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>2nd STREET 自動購入ツール</title>
  <style>body{font-family:sans-serif;padding:16px}</style>
</head>
<body>
  <h2>2nd STREET 自動購入ツール</h2>
  <p id="state">初期化中…</p>

  <script>
  (async ()=>{
    const sleep=t=>new Promise(r=>setTimeout(r,t));
    const log=(msg)=>document.getElementById('state').textContent=msg;
    const params=new URLSearchParams(location.search);
    const target=params.get('target');
    if(!target){log('❌ targetパラメータがありません');return;}

    /* ───────── これ以降、処理をポップアップ自身で行う ───────── */
    const popup=window.open(target,'_blank','width=480,height=780');
    if(!popup){log('❌ ポップアップを許可してください');return;}

    /* ユーザー設定 */
    const GEO_ID='09089145579';
    const GEO_PW ='s2518190';
    const BIRTH={y:'1980',m:'01',d:'25'};
    const JOB_CODE='4';

    /* 共通関数 */
    const wfe=(doc,sel,limit=40)=>new Promise((res,rej)=>{let c=0;const i=setInterval(()=>{const el=doc.querySelector(sel);if(el){clearInterval(i);res(el);}else if(++c>limit){clearInterval(i);rej('要素なし:'+sel);} },250);});

    const click=(el)=>{if(!el)return false;el.dispatchEvent(new MouseEvent('click',{bubbles:true,cancelable:true,view:popup}));return true;};

    /* メインループ */
    const main=async()=>{
      try{ log('📄 商品ページ待機');
        await wfe(popup.document,'#addCartBtn');
        log('🛒 カートに追加クリック');
        const btn=popup.document.querySelector('#addCartBtn');
        if(!click(btn))throw 'click失敗';
        /* cartRegist 直接呼び出し（保険）*/
        if(typeof popup.cartRegist==='function')popup.cartRegist(1);
        await sleep(1500);
        log('🚚 カートページへ');
        popup.location.href='/cart';

        /* カートページで「レジに進む」 */
        await wfe(popup.document,'button.cartBtn[form="cart_information_detail"]');
        click(popup.document.querySelector('button.cartBtn[form="cart_information_detail"]'));
        log('💳 レジに進むクリック');
        await sleep(2500);

        /* ログイン画面か判定 */
        if(popup.document.querySelector('#authId')){
          log('🔐 ログイン画面検出 – 自動入力');
          popup.document.querySelector('#authId').value=GEO_ID;
          popup.document.querySelector('input[name="password"]').value=GEO_PW;
          alert('GEO ID/パスワードを入力しました。reCAPTCHAを手動で完了してください。完了後、自動処理が続行されます。');
          return; // ユーザー操作待ち
        }

        /* 生年月日 & 職業入力 (古物法) */
        const ySel=popup.document.querySelector('select[name="birthdayYear"]');
        if(ySel){ ySel.value=BIRTH.y; popup.document.querySelector('select[name="birthdayMonth"]').value=BIRTH.m; popup.document.querySelector('select[name="birthdayDay"]').value=BIRTH.d; popup.document.querySelector('select[name="jobCode"]').value=JOB_CODE; log('📅 生年月日・職業入力'); await sleep(500);}        

        /* 最終確認へ */
        if(click(popup.document.querySelector('#submit-btn'))){ log('➡️ 最終確認へ'); await sleep(1500);}        
        /* 注文確定 */
        if(click(popup.document.querySelector('#order_submit'))){ log('✅ 注文確定クリック完了'); }
      }catch(e){log('⚠️ エラー:'+e);console.error(e);} }

    /* ポップアップロード完了監視して main 実行 */
    const onReady=()=>{ if(popup.document.readyState==='complete'){main();}else{popup.document.addEventListener('readystatechange',()=>{if(popup.document.readyState==='complete')main();});}}
    const timer=setInterval(()=>{ if(popup.document){clearInterval(timer);onReady();}},300);
  })();
  </script>
</body>
</html>
