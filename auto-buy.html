<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <title>2nd STREET Auto Buyer</title>
</head>
<body>
  <h3>2nd STREET 自動購入ツール</h3>
  <p>処理が始まります…</p>

  <script>
    (async function(){
      const params = new URLSearchParams(window.location.search);
      const target = params.get('target');
      if (!target) {
        document.body.innerHTML += '<p style="color:red">エラー：targetパラメータがありません。</p>';
        return;
      }

      // 商品ページへ移動
      window.location.href = target;
      await new Promise(res => setTimeout(res, 3000));

      // 汎用クリック関数
      const clickWhenReady = async (selector, timeout=10000) => {
        const start = Date.now();
        while (true) {
          const el = document.querySelector(selector);
          if (el) {
            el.click();
            console.log('Clicked:', selector);
            return true;
          }
          if (Date.now() - start > timeout) {
            console.error('Timeout:', selector);
            return false;
          }
          await new Promise(res => setTimeout(res, 500));
        }
      };

      // ステップ1：カートに追加
      const ok1 = await clickWhenReady('.cart_btn.addCartWideBtn, button.cartBtn', 10000);
      if (!ok1) return alert('❌ カート追加に失敗しました');

      // ステップ2：カート画面へ
      window.location.href = '/cart';
      await new Promise(res => setTimeout(res, 2000));

      // ステップ3：レジに進む
      const ok2 = await clickWhenReady('button.cartBtn.single', 5000);
      if (!ok2) return alert('❌ レジ進行に失敗しました');

      // ステップ4：生年月日・職業入力（あれば）
      const setInput = (name, value) => {
        const sel = document.querySelector(`[name="${name}"]`);
        if (sel) sel.value = value;
      };
      setInput('birthdayYear', '1990');
      setInput('birthdayMonth', '01');
      setInput('birthdayDay', '01');
      setInput('jobCode', '1');

      // 少し待って
      await new Promise(res => setTimeout(res, 1000));

      // ステップ5：最終確認
      const ok3 = await clickWhenReady('#submit-btn', 5000);
      if (!ok3) return alert('❌ 最終確認へ進めませんでした');

      await new Promise(res => setTimeout(res, 1000));

      // ステップ6：注文確定
      const ok4 = await clickWhenReady('#order_submit', 5000);
      if (!ok4) return alert('❌ 注文確定に失敗');

      alert('✅ 注文が完了しました！');
    })();
  </script>
</body>
</html>
