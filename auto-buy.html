<!DOCTYPE html>
<html>
<head>
  <title>2nd STREET 自動購入ツール</title>
  <meta charset="UTF-8">
  <style>
    body { font-family: sans-serif; padding: 20px; }
  </style>
</head>
<body>
  <h1>2nd STREET 自動購入ツール</h1>
  <p>処理中... ポップアップが開かれ、購入処理が進行します。</p>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const targetUrl = urlParams.get("target");

    const birthday = { year: "1980", month: "01", day: "25" };
    const jobCode = "4";
    const loginId = "09089145579";
    const password = "s2518190";

    if (!targetUrl) {
      document.body.innerHTML += '<p style="color:red">エラー：targetパラメータがありません。</p>';
      throw new Error("No target URL");
    }

    const popup = window.open(targetUrl, "_blank", "width=480,height=800");

    const wait = ms => new Promise(res => setTimeout(res, ms));

    const runScript = async () => {
      if (!popup || popup.closed) {
        alert("ポップアップをブロックされました。ポップアップを許可してください。")
        return;
      }

      const tryAccess = async () => {
        try {
          const doc = popup.document;

          // ログイン画面検出と自動入力
          const loginInput = doc.querySelector("input[name='login_id']");
          const passInput = doc.querySelector("input[name='password']");
          if (loginInput && passInput) {
            loginInput.value = loginId;
            passInput.value = password;
            return;
          }

          // カートボタン
          const cartBtn = doc.querySelector("#addCartBtn");
          if (cartBtn) {
            cartBtn.click();
            await wait(1500);
          }

          // カートを確認するへ遷移
          const toCart = doc.querySelector(".cartbar a[href='/cart']");
          if (toCart) {
            toCart.click();
            await wait(2000);
          }

          // レジに進む
          const checkoutBtn = doc.querySelector("button[form='cart_information_detail']");
          if (checkoutBtn) {
            checkoutBtn.click();
            await wait(2000);
          }

          // 生年月日と職業の入力
          const yearSel = doc.querySelector("select[name='birthdayYear']");
          const monthSel = doc.querySelector("select[name='birthdayMonth']");
          const daySel = doc.querySelector("select[name='birthdayDay']");
          const jobSel = doc.querySelector("select[name='jobCode']");
          if (yearSel && monthSel && daySel && jobSel) {
            yearSel.value = birthday.year;
            monthSel.value = birthday.month;
            daySel.value = birthday.day;
            jobSel.value = jobCode;
            await wait(1000);
          }

          // 最終確認へ
          const confirmBtn = doc.querySelector("#submit-btn");
          if (confirmBtn) {
            confirmBtn.click();
            await wait(1500);
          }

          // ご注文を確定する
          const submitBtn = doc.querySelector("#order_submit");
          if (submitBtn) {
            submitBtn.click();
          }
        } catch (e) {
          console.warn("リトライ...", e);
        }
      }

      // ポップアップが読み込まれるまで待って監視開始
      for (let i = 0; i < 30; i++) {
        await wait(1000);
        try {
          if (popup.document.readyState === "complete") {
            await tryAccess();
            break;
          }
        } catch (_) {}
      }
    };

    runScript();
  </script>
</body>
</html>
