<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>2nd STREET è‡ªå‹•è³¼å…¥ãƒ„ãƒ¼ãƒ«</title>
<style>body{font-family:sans-serif;padding:16px}</style>
</head>
<body>
<h2>2nd STREET è‡ªå‹•è³¼å…¥ãƒ„ãƒ¼ãƒ«</h2>
<p id="state">åˆæœŸåŒ–ä¸­â€¦</p>

<script>
(async () => {
  /* ========== ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š ========== */
  const BIRTH = { y:'1980', m:'01', d:'25' };   // ç”Ÿå¹´æœˆæ—¥
  const JOB   = '4';                            // è·æ¥­ value="4" = è‡ªå–¶æ¥­

  /* ========== å…±é€šé–¢æ•° ========== */
  const sleep = ms => new Promise(r => setTimeout(r, ms));
  const log   = msg => document.getElementById('state').textContent = msg;
  const wait  = (doc,sel,lim=40) =>
      new Promise((res,rej)=>{let c=0;const t=setInterval(()=>{try{
        const el=doc.querySelector(sel); if(el){clearInterval(t);res(el);}
        else if(++c>lim){clearInterval(t);rej('è¦ç´ ãªã—:'+sel);}
      }catch(e){}},250);});

  const dispatchTap = el =>
      ['pointerdown','touchstart','mousedown',
       'touchend','pointerup','click']
      .forEach(ev => el.dispatchEvent(new Event(ev,{bubbles:true,cancelable:true})));

  /* ========== ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—èµ·å‹• ========== */
  const target = new URLSearchParams(location.search).get('target');
  if (!target) { log('âŒ target ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

  const pop = window.open(target,'_blank','width=480,height=800');
  if (!pop) { log('âŒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„'); return; }

  /* ========== ãƒ¡ã‚¤ãƒ³å‡¦ç† ========== */
  const main = async () => {
    try {
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ã‚«ãƒ¼ãƒˆè¿½åŠ ï¼ˆç¢ºå®šç‰ˆï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
log('ğŸ›’ ãƒœã‚¿ãƒ³æ¤œå‡ºï¼†ã‚¿ãƒƒãƒç™ºç«');
const btn = await wait(pop.document,'#addCartBtn,button.addCartBtn');
btn.scrollIntoView({block:'center'});

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œåˆ¤å®šã‚’é€šã™ãŸã‚ãƒ•ãƒ«ã‚¿ãƒƒãƒé€£æ‰“ */
['pointerdown','touchstart','mousedown',
 'touchend','pointerup','click']
.forEach(ev => btn.dispatchEvent(
  new Event(ev,{bubbles:true,cancelable:true,view:pop})
));

/* ä¿é™ºï¼šcartRegist(goodsId, shopsId, qty) ã‚’ç›´æ¥å®Ÿè¡Œ */
const idMatch = pop.location.href.match(/goodsId\\/(\\d+)\\/shopsId\\/(\\d+)/);
if (idMatch && typeof pop.cartRegist === 'function') {
  const [_, GOODS, SHOP] = idMatch;
  pop.cartRegist(GOODS, SHOP, 1);
}

/* è¿½åŠ ãƒãƒ¼ (#addedCart) or .cartbar å‡ºç¾ã¾ã§å¾…ã¤ */
await wait(pop.document,'#addedCart,.cartbar',60);
log('ğŸ›’ è¿½åŠ ç¢ºèª â†’ ã‚«ãƒ¼ãƒˆãƒšãƒ¼ã‚¸');
await sleep(700);
pop.location.href='/cart';
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ã“ã“ã¾ã§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */



      /* --- ã‚«ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ï¼šãƒ¬ã‚¸ã«é€²ã‚€ --- */
      await wait(pop.document,'button.cartBtn[form=\"cart_information_detail\"]');
      dispatchTap(pop.document.querySelector('button.cartBtn[form=\"cart_information_detail\"]'));
      log('ğŸ’³ ãƒ¬ã‚¸ã«é€²ã‚€ã‚¯ãƒªãƒƒã‚¯');
      await sleep(2500);

      /* --- ã“ã“ã§ auth.geonet.jp ã¸é·ç§»ã™ã‚‹å ´åˆãŒã‚ã‚‹ --- */
      if (!pop.location.hostname.includes('2ndstreet.jp')) {
        log('ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ â€“ æ‰‹å‹•ã§ reCAPTCHA èªè¨¼ã—ã¦ã‹ã‚‰ã€Œãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãƒ¬ã‚¸ã«é€²ã‚€ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚å®Œäº†å¾Œã«å‡¦ç†ãŒå†é–‹ã—ã¾ã™ã€‚');
        return;           // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¾…ã¡ï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯æ®‹ã‚‹ï¼‰
      }

      /* --- ç”Ÿå¹´æœˆæ—¥ãƒ»è·æ¥­å…¥åŠ› --- */
      if (pop.document.querySelector('select[name=\"birthdayYear\"]')) {
        log('ğŸ“… ç”Ÿå¹´æœˆæ—¥ãƒ»è·æ¥­å…¥åŠ›');
        pop.document.querySelector('select[name=\"birthdayYear\"]').value = BIRTH.y;
        pop.document.querySelector('select[name=\"birthdayMonth\"]').value = BIRTH.m;
        pop.document.querySelector('select[name=\"birthdayDay\"]').value   = BIRTH.d;
        pop.document.querySelector('select[name=\"jobCode\"]').value      = JOB;
        await sleep(600);
      }

      /* --- æœ€çµ‚ç¢ºèª â†’ æ³¨æ–‡ç¢ºå®š --- */
      dispatchTap(pop.document.querySelector('#submit-btn'));
      log('â¡ï¸ æœ€çµ‚ç¢ºèªã«é€²ã‚€');
      await sleep(1800);
      dispatchTap(pop.document.querySelector('#order_submit'));
      log('âœ… æ³¨æ–‡ç¢ºå®šã‚¯ãƒªãƒƒã‚¯å®Œäº† â€“ è³¼å…¥å‡¦ç†çµ‚äº†');

    } catch(e) {
      console.error(e);
      log('âš ï¸ ã‚¨ãƒ©ãƒ¼: '+e);
    }
  };

  /* ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒæˆ»ã£ãŸã‚‰å†å®Ÿè¡Œï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œç”¨ï¼‰ */
  const observer = setInterval(()=>{
    try {
      if (pop.closed) { clearInterval(observer); log('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ'); }
      else if (pop.location.hostname.includes('2ndstreet.jp') &&
               pop.document.readyState === 'complete') {
        clearInterval(observer);
        main();
      }
    } catch(_) { /* ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ä¸­ã¯ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ */ }
  }, 800);
})();
</script>
</body>
</html>
