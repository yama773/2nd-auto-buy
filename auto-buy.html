<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>2nd STREET 自動購入ツール</title>
<style>body{font-family:sans-serif;padding:16px}</style>
</head>
<body>
<h2>2nd STREET 自動購入ツール</h2>
<p id="state">初期化中…</p>

<script>
(async () => {
  /* ========== ユーザー設定 ========== */
  const BIRTH = { y:'1980', m:'01', d:'25' };   // 生年月日
  const JOB   = '4';                            // 職業 value="4" = 自営業

  /* ========== 共通関数 ========== */
  const sleep = ms => new Promise(r => setTimeout(r, ms));
  const log   = msg => document.getElementById('state').textContent = msg;
  const wait  = (doc,sel,lim=40) =>
      new Promise((res,rej)=>{let c=0;const t=setInterval(()=>{try{
        const el=doc.querySelector(sel); if(el){clearInterval(t);res(el);}
        else if(++c>lim){clearInterval(t);rej('要素なし:'+sel);}
      }catch(e){}},250);});

  const dispatchTap = el =>
      ['pointerdown','touchstart','mousedown',
       'touchend','pointerup','click']
      .forEach(ev => el.dispatchEvent(new Event(ev,{bubbles:true,cancelable:true})));

  /* ========== ポップアップ起動 ========== */
  const target = new URLSearchParams(location.search).get('target');
  if (!target) { log('❌ target パラメータがありません'); return; }

  const pop = window.open(target,'_blank','width=480,height=800');
  if (!pop) { log('❌ ポップアップを許可してください'); return; }

  /* ========== メイン処理 ========== */
  const main = async () => {
    try {
/* ───────── カート追加（確定版） ───────── */
log('🛒 ボタン検出＆タッチ発火');
const btn = await wait(pop.document,'#addCartBtn,button.addCartBtn');
btn.scrollIntoView({block:'center'});

/* ユーザー操作判定を通すためフルタッチ連打 */
['pointerdown','touchstart','mousedown',
 'touchend','pointerup','click']
.forEach(ev => btn.dispatchEvent(
  new Event(ev,{bubbles:true,cancelable:true,view:pop})
));

/* 保険：cartRegist(goodsId, shopsId, qty) を直接実行 */
const idMatch = pop.location.href.match(/goodsId\\/(\\d+)\\/shopsId\\/(\\d+)/);
if (idMatch && typeof pop.cartRegist === 'function') {
  const [_, GOODS, SHOP] = idMatch;
  pop.cartRegist(GOODS, SHOP, 1);
}

/* 追加バー (#addedCart) or .cartbar 出現まで待つ */
await wait(pop.document,'#addedCart,.cartbar',60);
log('🛒 追加確認 → カートページ');
await sleep(700);
pop.location.href='/cart';
/* ─────────── ここまで ─────────── */



      /* --- カートページ：レジに進む --- */
      await wait(pop.document,'button.cartBtn[form=\"cart_information_detail\"]');
      dispatchTap(pop.document.querySelector('button.cartBtn[form=\"cart_information_detail\"]'));
      log('💳 レジに進むクリック');
      await sleep(2500);

      /* --- ここで auth.geonet.jp へ遷移する場合がある --- */
      if (!pop.location.hostname.includes('2ndstreet.jp')) {
        log('🔐 ログインページ – 手動で reCAPTCHA 認証してから「ログインしてレジに進む」を押してください。完了後に処理が再開します。');
        return;           // ユーザー操作待ち（スクリプトは残る）
      }

      /* --- 生年月日・職業入力 --- */
      if (pop.document.querySelector('select[name=\"birthdayYear\"]')) {
        log('📅 生年月日・職業入力');
        pop.document.querySelector('select[name=\"birthdayYear\"]').value = BIRTH.y;
        pop.document.querySelector('select[name=\"birthdayMonth\"]').value = BIRTH.m;
        pop.document.querySelector('select[name=\"birthdayDay\"]').value   = BIRTH.d;
        pop.document.querySelector('select[name=\"jobCode\"]').value      = JOB;
        await sleep(600);
      }

      /* --- 最終確認 → 注文確定 --- */
      dispatchTap(pop.document.querySelector('#submit-btn'));
      log('➡️ 最終確認に進む');
      await sleep(1800);
      dispatchTap(pop.document.querySelector('#order_submit'));
      log('✅ 注文確定クリック完了 – 購入処理終了');

    } catch(e) {
      console.error(e);
      log('⚠️ エラー: '+e);
    }
  };

  /* ドメインが戻ったら再実行（ログイン後用） */
  const observer = setInterval(()=>{
    try {
      if (pop.closed) { clearInterval(observer); log('ポップアップが閉じられました'); }
      else if (pop.location.hostname.includes('2ndstreet.jp') &&
               pop.document.readyState === 'complete') {
        clearInterval(observer);
        main();
      }
    } catch(_) { /* クロスオリジン中はアクセス不可 */ }
  }, 800);
})();
</script>
</body>
</html>
