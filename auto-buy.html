<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <title>2nd STREET Auto Buyer</title>
</head>
<body>
  <h3>2nd STREET 自動購入ツール</h3>
  <p>処理中です。手動でreCAPTCHAを突破する場面があれば対応してください。</p>

  <script>
    (async function(){
      const delay = ms => new Promise(res => setTimeout(res, ms));
      const params = new URLSearchParams(location.search);
      const target = params.get("target");

      if (!target) {
        document.body.innerHTML += '<p style="color:red">エラー：targetパラメータがありません。</p>';
        return;
      }

      // ステップ1：商品ページへ遷移
      if (!location.href.includes("goodsId")) {
        location.href = target;
        return;
      }

      // ステップ2：DOM完全読み込みを待つ
      function waitForElm(selector, maxTry = 20, interval = 500) {
        return new Promise(async (resolve, reject) => {
          for (let i = 0; i < maxTry; i++) {
            const elm = document.querySelector(selector);
            if (elm) return resolve(elm);
            await delay(interval);
          }
          reject("要素が見つかりません: " + selector);
        });
      }

      try {
        const addBtn = await waitForElm("#addCartBtn");
        addBtn.click();
        await delay(2000);
        location.href = "/cart";
      } catch (e) {
        alert("❌ カートボタンが見つかりませんでした");
        return;
      }

      // ステップ3：レジに進む
      try {
        const regibtn = await waitForElm("button.cartBtn");
        regibtn.click();
        await delay(2000);
      } catch {}

      // ステップ4：ログイン自動入力（reCAPTCHAは手動）
      const loginId = document.querySelector("#authId");
      const password = document.querySelector('input[name="password"]');
      const loginBtn = document.querySelector("#js-submit_btn");
      if (loginId && password && loginBtn) {
        loginId.value = "09089145579";
        password.value = "s2518190";
        await delay(500);
        loginBtn.click();
        return;
      }

      // ステップ5：古物法フォーム入力
      const setVal = (sel, val) => {
        const el = document.querySelector(sel);
        if (el) el.value = val;
      };
      setVal('select[name="birthdayYear"]', "1990");
      setVal('select[name="birthdayMonth"]', "01");
      setVal('select[name="birthdayDay"]', "01");
      setVal('select[name="jobCode"]', "1");

      await delay(1000);

      // ステップ6：最終確認→確定
      const confirmBtn = document.querySelector("#submit-btn");
      if (confirmBtn) confirmBtn.click();

      await delay(1500);

      const finalBtn = document.querySelector("#order_submit");
      if (finalBtn) finalBtn.click();

      alert("✅ 自動購入完了または最終確認まで実行しました。");

    })();
  </script>
</body>
</html>
