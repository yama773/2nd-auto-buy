<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>2nd STREET 自動購入ツール</title>
  <script>
    (async () => {
      document.addEventListener('DOMContentLoaded', run);
      async function run() {
        document.body.innerHTML = "<h2>2nd STREET 自動購入ツール</h2><p>処理中… ポップアップが開かれ、購入処理が進行します。</p>";

        const target = new URLSearchParams(location.search).get("target");
        if (!target) {
          document.body.innerHTML += "<p style='color:red'>エラー：targetパラメータがありません。</p>";
          return;
        }

        const popup = window.open(target, "_blank", "width=800,height=1000");

        if (!popup) {
          document.body.innerHTML += "<p style='color:red'>ポップアップがブロックされました。ポップアップを許可してください。</p>";
          return;
        }

        const steps = async () => {
          try {
            const sleep = ms => new Promise(res => setTimeout(res, ms));

            await sleep(1000);

            const check = setInterval(async () => {
              if (!popup.document || popup.closed) {
                clearInterval(check);
                return;
              }

              const d = popup.document;

              // ステップ1: カートに追加
              const cartBtn = d.querySelector('#addCartBtn');
              if (cartBtn) {
                cartBtn.click();
                clearInterval(check);
                await sleep(1500);
                nextStep();
              }
            }, 500);

            const nextStep = async () => {
              await sleep(1000);

              // ステップ2: 「カートを確認する」
              const cartLink = popup.document.querySelector('.cartbar a[href="/cart"]');
              if (cartLink) {
                cartLink.click();
              }

              await sleep(3000);

              // ステップ3: ログインページ対応（自動入力）
              const authId = popup.document.querySelector('#authId');
              if (authId) {
                authId.value = "09089145579";
                popup.document.querySelector('input[name="password"]').value = "s2518190";
                document.body.innerHTML += "<p>ログイン画面に入力しました。reCAPTCHAを手動で処理してください。</p>";
                return;
              }

              // ステップ4: 「レジに進む」
              const checkoutBtn = popup.document.querySelector('button.cartBtn[form="cart_information_detail"]');
              if (checkoutBtn) {
                checkoutBtn.click();
              }

              await sleep(3000);

              // ステップ5: 生年月日・職業入力
              const y = popup.document.querySelector('select[name="birthdayYear"]');
              if (y) y.value = "1980";
              const m = popup.document.querySelector('select[name="birthdayMonth"]');
              if (m) m.value = "01";
              const d = popup.document.querySelector('select[name="birthdayDay"]');
              if (d) d.value = "25";
              const job = popup.document.querySelector('select[name="jobCode"]');
              if (job) job.value = "4";

              await sleep(1500);

              // ステップ6: 最終確認へ
              const confirmBtn = popup.document.querySelector('#submit-btn');
              if (confirmBtn) confirmBtn.click();

              await sleep(2000);

              // ステップ7: 注文確定
              const orderBtn = popup.document.querySelector('#order_submit');
              if (orderBtn) orderBtn.click();

              document.body.innerHTML += "<p>✅ 購入処理を完了しました（確認してください）</p>";
            };

          } catch (e) {
            document.body.innerHTML += `<p style='color:red'>エラーが発生しました：${e.message}</p>`;
          }
        };

        popup.onload = steps;
      }
    })();
  </script>
</head>
<body>
</body>
</html>
